<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>千里之行 始于足下 - scrapy</title>
    <meta name="description" content="">
    <meta name="author" content="qianlizhixing">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Le styles -->
    <link href="/theme/bootstrap.min.css" rel="stylesheet">
    <link href="/theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="/theme/local.css" rel="stylesheet">
    <link href="/theme/pygments.css" rel="stylesheet">
    <link rel="shortcut icon" href="/theme/images/icons/favicon.ico" type="image/x-icon">
</head>

<body>

    <div class="navbar">
        <div class="navbar-inner">
            <div class="container">

                <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </a>

                <a class="brand" name="hostpage">千里之行 始于足下</a>

                <div class="nav-collapse">
                    <ul class="nav">
                    </ul>
                </div>

            </div>
        </div>
    </div>

    <div class="container">
        <div class="content">
            <div class="row">

                <div class="span9">
        

        


    <div class='article'>
        <div class="content-title">
            <a href="/artsdi-san-shi-er-zhou.html"><h1>ARTS第三十二周</h1></a>
2021-06-14

<a class="url fn">qianlizhixing</a>


 
        </div>
        
        <div><h2>Algorithm</h2>
<p>leetcode 494 目标和</p>
<ul>
<li><a href="https://leetcode-cn.com/problems/target-sum/">原题</a></li>
<li><a href="https://github.com/qianlizhixing12/coding-training/blob/main/leetcode/494.py">解题</a></li>
<li>动态规划转换为背包问题</li>
</ul>
<h2>Review</h2>
<blockquote>
<p>https://www.kernel.org/doc/html/latest/process/coding-style.html</p>
</blockquote>
<h4>缩进</h4>
<ul>
<li>制表符是8个字符，缩进也是8个字符</li>
<li>不要把多个语句放在一行里，不要用逗号来避免使用大括号</li>
<li>除了注释、文档和Kconfig之外，空格从不用于缩进</li>
<li>不要在行尾留下空白</li>
</ul>
<h4>断开长行长字符串</h4>
<ul>
<li>单行长度的首选限制是80列</li>
<li>超过80列的语句应该被分成合理的块，除非超过80列会显著增加可读性</li>
<li>一个非常常用的样式是将断开行对齐到函数开括号</li>
<li>这些规则适用于带有长参数列表的函数头</li>
</ul>
<h4>括号和空格</h4>
<ul>
<li>首选的方式是把左括号放在行末，把右括号放在行首，独占一行，适用于所有非函数语句块(if, switch, for, while, do)</li>
<li>函数在下一行行首开始左括号，独占一行</li>
<li>不要在单个语句使用大括号</li>
<li>在保留词后面加一个空格</li>
<li>不要在圆括号周围添加空格</li>
<li>当声明指针数据或返回指针类型的函数时，*的首选用法是紧邻数据名或函数名，而不是紧邻类型名</li>
<li>在大多数二元和三元运算符周围(每边)使用一个空格</li>
<li>一元运算符后不能有空格</li>
<li>不要在行尾留下空格</li>
</ul>
<h4>命名</h4>
<ul>
<li>全局变量需要有描述性的名称，就像全局函数一样。例如一个计算活动用户数量的函数，应该调用count_active_users()，不应该调用cntusr()</li>
<li>将函数的类型编码到名称中是愚蠢的</li>
<li>局部变量的名称应该简短且切中要害</li>
</ul>
<h4>函数</h4>
<ul>
<li>函数应该简短亲切，只做一件事并且做得很好</li>
<li>函数局部变量的数量不应该超过5-10个</li>
<li>在函数原型中，包含参数名及其数据类型</li>
</ul>
<h4>注释</h4>
<ul>
<li>将注释放在函数的开头，告诉人们它做什么，以及它为什么这样做</li>
</ul>
<h2>Tip</h2>
<ul>
<li>os模块负责程序与操作系统的交互，提供了访问操作系统底层的接口</li>
<li>sys模块负责程序与python解释器的交互，提供了一系列的函数和变量，用于操控python的运行时环境</li>
</ul>
<h4>运行信息</h4>
<ul>
<li>系统平台sys.platform</li>
<li>解释器版本信息sys.version sys.version_info</li>
<li>当前Unicode实现所使用的默认字符串编码名称sys.getdefaultencoding()</li>
<li>命令行传递参数sys.argv</li>
<li>sys.getrefcount()对象引用计数，返回的计数通常比预期的多一，因为它包括了作为getrefcount()参数的这一次临时引用</li>
<li>sys.modules将模块名称映射到已加载的模块。可以操作该字典来强制重新加载模块，或是实现其他技巧。但是，替换的字典不一定会按预期工作，并且从字典中删除必要的项目可能会导致Python崩溃</li>
<li>sys.path字符串组成的列表，用于指定模块的搜索路径。初始化自环境变量PYTHONPATH，再加上一条与安装有关的默认路径</li>
<li>运行环境变量os.environ</li>
</ul>
<h4>进程管理</h4>
<ul>
<li>模拟传统的UNIX函数发信号给进程(UNIX平台上有效)os.kill(os.getpid(), signal.SIGILL)</li>
<li>os.fork()无法在Windows系统中使用，父进程中os.fork()返回子进程pid，子进程中os.fork()返回0</li>
<li>os.system通过fork一个子进程,然后该子进程执行命令，阻塞等待子进程结束，返回命令执行结果的返回值</li>
<li>os.popen创建一个管道，通过fork一个子进程,然后该子进程执行命令</li>
</ul>
<h4>文件操作</h4>
<ul>
<li>
<p>拼接路径os.path.join(dir, path)</p>
</li>
<li>
<p>新建文件夹os.makedirs(os.path.dirname(file_full_path))</p>
</li>
<li>删除文件夹os.rmdir(os.path.dirname(file_full_path))</li>
<li>判断文件夹存在os.path.exists(os.path.dirname(file_full_path))</li>
<li>目录文件列表os.listdir(os.path.dirname(file_full_path))</li>
<li>判断资源类型(是否文件)os.path.isfile(file_full_path)</li>
<li>删除文件os.remove(file_full_path)</li>
<li>移动(重命名)os.rename(src_file_full_path, des_file_full_path)</li>
</ul>
<h4>ini文件解析</h4>
<ul>
<li>configparser模块</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">configparser</span>


<span class="k">def</span> <span class="nf">doini</span><span class="p">():</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;test.ini&quot;</span>

    <span class="c1"># 加载ini</span>
    <span class="n">iniFile</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">iniFile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># 添加或更新节点</span>
    <span class="n">section</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="s2">&quot;30&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">iniFile</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
        <span class="n">iniFile</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
    <span class="n">iniFile</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="c1"># 删除节点</span>
    <span class="n">section</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span><span class="p">,</span> <span class="s2">&quot;retry&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span>
    <span class="k">if</span> <span class="n">iniFile</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">iniFile</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="n">iniFile</span><span class="o">.</span><span class="n">remove_option</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iniFile</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">section</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">iniFile</span><span class="o">.</span><span class="n">remove_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

    <span class="c1"># 回写ini</span>
    <span class="n">iniFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">doini</span><span class="p">()</span>
</code></pre></div>

<h4>注册表操作</h4>
<ul>
<li>winreg模块</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">winreg</span>


<span class="k">def</span> <span class="nf">doreg</span><span class="p">(</span><span class="n">regList</span><span class="p">):</span>
    <span class="c1"># root</span>
    <span class="n">root</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">winreg</span><span class="o">.</span><span class="n">HKEY_CURRENT_USER</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;ttt\www&quot;</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">winreg</span><span class="o">.</span><span class="n">CreateKey</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 添加或更新</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;sss&quot;</span>
        <span class="n">winreg</span><span class="o">.</span><span class="n">SetValueEx</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">winreg</span><span class="o">.</span><span class="n">REG_SZ</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># 删除</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;port&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">winreg</span><span class="o">.</span><span class="n">QueryInfoKey</span><span class="p">(</span><span class="n">reg</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">winreg</span><span class="o">.</span><span class="n">EnumValue</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">):</span>
                <span class="n">winreg</span><span class="o">.</span><span class="n">DeleteValue</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">winreg</span><span class="o">.</span><span class="n">CloseKey</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
</code></pre></div>

<h2>Share(scrapy setting)</h2>
<blockquote>
<p>https://docs.scrapy.org/en/latest/intro/tutorial.html</p>
</blockquote>
<h4>项目结构</h4>
<p><img alt="scrapy_files" src=".\img\scrapy_files.png"></p>
<ul>
<li>scrapy.cfg部署配置文件</li>
<li>settings.py项目设置文件</li>
<li>items.py采集项定义文件</li>
<li>pipelines.py采集管道文件</li>
<li>middlewares.py中间件文件</li>
<li>spiders/爬虫器目录</li>
</ul>
<h4>源码结构</h4>
<ul>
<li>随着scrapy系列文章，会逐渐补充</li>
<li>scrapy.cmdline  命令入口</li>
<li>scrapy.commands 命令目录</li>
<li>scrapy.templates 创建新项目或新爬取器模板</li>
<li>scrapy.utils工具函数</li>
<li>scrapy.utils.project 项目设置，数据处理函数</li>
<li>scrapy.utils.conf 部署配置处理函数</li>
<li>scrapy.utils.versions 版本处理函数</li>
<li>scrapy.utils.template 模板变量字符串替换处理</li>
<li>scrapy.settings运行设置</li>
<li>__init__ 类定义</li>
<li>default_settings默认设置</li>
</ul>
<h4>命令</h4>
<h5>全局命令</h5>
<ul>
<li>
<p>startproject</p>
</li>
<li>
<p>genspider</p>
</li>
<li>
<p>settings</p>
</li>
<li>
<p>runspider</p>
</li>
<li>
<p>shell</p>
</li>
<li>
<p>fetch</p>
</li>
<li>
<p>view</p>
</li>
<li>
<p>version</p>
</li>
</ul>
<h5>Project命令</h5>
<ul>
<li>
<p>crawl</p>
</li>
<li>
<p>check</p>
</li>
<li>
<p>list</p>
</li>
<li>
<p>edit</p>
</li>
<li>
<p>parse</p>
</li>
<li>
<p>bench</p>
</li>
</ul>
<p>命令的入口都为scrapy.cmdline.execute，根据具体命令执行scrapy.commands下具体命令</p>
<h4>配置读取</h4>
<ul>
<li>
<p>scrapy第一步先找部署配置文件，因为部署配置里面包含了运行设置项的路径配置和部署配置，如果本地运行execute时指定了settings运行配置，程序忽略部署配置文件和运行配置项的解析</p>
</li>
<li>
<p>get_project_settings逻辑</p>
</li>
<li>
<p>当环境变量没有SCRAPY_SETTINGS_MODULE，调用init_env从部署配置文件读取settings填充SCRAPY_SETTINGS_MODULE，init_env还会把部署配置文件的目录加入sys.path</p>
</li>
<li>
<p>部署配置文件ini格式，可以在/etc/scrapy.cfg，c:\scrapy\scrapy.cfg，home/user/.config/scrapy.cfg，home/user/.scrapy.cfg和当前目录及父目录递层向上查找</p>
</li>
<li>
<p>Settings类初始化加载default_settings默认配置(优先级default)，配置项SettingsAttribute的priority有5个优先级，高优先级覆盖低优先级</p>
</li>
</ul>
<p>```python
  class SettingsAttribute:</p>
<div class="highlight"><pre><span></span><code>  ...

  <span class="nv">def</span> <span class="nv">set</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">value</span>, <span class="nv">priority</span><span class="ss">)</span>:
      <span class="s2">&quot;&quot;&quot;</span><span class="s">Sets value if priority is higher or equal than current priority.</span><span class="s2">&quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="nv">priority</span> <span class="o">&gt;=</span> <span class="nv">self</span>.<span class="nv">priority</span>:
          <span class="k">if</span> <span class="nv">isinstance</span><span class="ss">(</span><span class="nv">self</span>.<span class="nv">value</span>, <span class="nv">BaseSettings</span><span class="ss">)</span>:
              <span class="nv">value</span> <span class="o">=</span> <span class="nv">BaseSettings</span><span class="ss">(</span><span class="nv">value</span>, <span class="nv">priority</span><span class="o">=</span><span class="nv">priority</span><span class="ss">)</span>
          <span class="nv">self</span>.<span class="nv">value</span> <span class="o">=</span> <span class="nv">value</span>
          <span class="nv">self</span>.<span class="nv">priority</span> <span class="o">=</span> <span class="nv">priority</span>
</code></pre></div>

<p>```</p>
<h4>执行命令</h4>
<ul>
<li>动态从scrapy.commands目录下加载所有模块，并从模块中找到继承自ScrapyCommand的类，文件名为命令名(exectue参数argv[1:]开始第一个不以-开始的值)，创建命令名到执行实例的映射</li>
<li>使用optparse解析命令参数</li>
<li>调用cmd.add_options将每个命令需要的参数定义到optparse</li>
<li>调用cmd.process_options将optparse加入或更新settings(优先级为cmdline)</li>
<li>调用cmd.run运行命令</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 显示版本命令</span>
<span class="kn">from</span> <span class="nn">scrapy.cmdline</span> <span class="kn">import</span> <span class="n">execute</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># 获取当前脚本路径</span>
<span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="c1">#切换工作目录</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
<span class="n">execute</span><span class="p">([</span><span class="s1">&#39;scrapy&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;-v&#39;</span><span class="p">])</span>

<span class="c1"># 输出</span>
<span class="c1"># Scrapy       : 2.5.0</span>
<span class="c1"># lxml         : 4.6.3.0</span>
<span class="c1"># libxml2      : 2.9.5</span>
<span class="c1"># cssselect    : 1.1.0</span>
<span class="c1"># parsel       : 1.6.0</span>
<span class="c1"># w3lib        : 1.22.0</span>
<span class="c1"># Twisted      : 21.2.0</span>
<span class="c1"># Python       : 3.8.10 (tags/v3.8.10:3d8993a, May  3 2021, 11:48:03) [MSC v.1928 64 bit (AMD64)]</span>
<span class="c1"># pyOpenSSL    : 20.0.1 (OpenSSL 1.1.1k  25 Mar 2021)</span>
<span class="c1"># cryptography : 3.4.7</span>
<span class="c1"># Platform     : Windows-10-10.0.19043-SP0</span>
</code></pre></div></div>
        <hr />
    </div>
		
<div class="pagination">
<ul>
    <li class="prev disabled"><a href="#">&larr; Previous</a></li>

    <li class="active"><a href="/tag/scrapy.html">1</a></li>

    <li class="next disabled"><a href="#">&rarr; Next</a></li>

</ul>
</div>
 
  
                </div>

                <div class="span3">

                    <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
                        <ul class="nav nav-list">
                            <li class="nav-header">
                                Site
                            </li>

                            <li><a href="/archives.html">Archives</a>
                            <li><a href="/tags.html">Tags</a>
                        </ul>
                    </div>


                    <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
                        <ul class="nav nav-list">
                            <li class="nav-header">
                                Categories
                            </li>

                            <li><a href="/category/arts.html">ARTS</a></li>
                            <li><a href="/category/cheng-xu-yuan-sheng-ya.html">程序员生涯</a></li>
                        </ul>
                    </div>
                </div>             </div>         </div> 
        <footer>
            <br />
            <p><a name="hostpage">千里之行 始于足下</a> &copy; qianlizhixing 2021</p>
        </footer>

    </div> <!-- /container -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/theme/bootstrap-collapse.js"></script>
    <script>
        document.getElementsByName("hostpage").forEach((item) => {
            item.href = window.location.origin;
        });
    </script>
</body>

</html>